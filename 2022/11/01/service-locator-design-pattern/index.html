<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  
  <title>Service Locator design pattern</title>
  <meta name="description" content="During creating and designing the architechture of applications, we create a lot of objects (“Services”) and managing these objects in a big application without a service container will become a nightmare eventually.">
  

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://read.adumb.codes/2022/11/01/service-locator-design-pattern/">
  
  
  <link rel="alternate" type="application/rss+xml" title="read.adumb.codes" href="https://read.adumb.codes/feed.xml">

  

  
  <meta property="og:title" content="Service Locator design pattern">
  <meta property="og:site_name" content="read.adumb.codes">
  <meta property="og:url" content="https://read.adumb.codes/2022/11/01/service-locator-design-pattern/">
  <meta property="og:description" content="During creating and designing the architechture of applications, we create a lot of objects (“Services”) and managing these objects in a big application without a service container will become a nightmare eventually.">
  
  
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="ikbenalireza">
  <meta name="twitter:title" content="Service Locator design pattern">
  <meta name="twitter:description" content="During creating and designing the architechture of applications, we create a lot of objects (“Services”) and managing these objects in a big application without a service container will become a ni...">
  
    <meta name="twitter:creator" content="ikbenalireza">
  
  

  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bitter:ital,wght@0,400;0,700;1,400&amp;display=swap" rel="stylesheet">

  

</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">read.adumb.codes</a>

    <nav class="site-nav">
      
        
        <a class="page-link" href="https://github.com/adumbcodes">GitHub</a>
      
    </nav>

  </div>

</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    
      <h1 class="post-title" itemprop="name headline">Service Locator design pattern</h1>
    
    <p class="post-meta"><time datetime="2022-11-01T00:00:00+01:00" itemprop="datePublished">Nov 1, 2022</time> •
  
    
    
      
        <a href="/categories/software/">software</a>,
      
    
      
    
  
    
    
      
    
      
        <a href="/categories/design-pattern/">design-pattern</a>
      
    
  



</p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>During creating and designing the architechture of applications, we create a lot of objects (“Services”) and managing these objects in a big application without a service container will become a nightmare eventually.</p>

<!-- more -->

<h2>What is service container?</h2>
<p>A service container is a form of inversion of control (“IoC”) which is just an array or in other terms registry of instantiated services which uses service locator pattern to give you access to registered services.</p>

<p>Below you can find a very simple implementation of service container compatible with <a href="https://www.php-fig.org/psr/psr-11/">PSR-11</a>.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Psr\Container\ContainerInterface</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Container</span> <span class="kd">implements</span> <span class="nc">ContainerInterface</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="nv">$registry</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">):</span> <span class="kt">object</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="nf">has</span><span class="p">(</span><span class="nv">$id</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="p">(</span><span class="s1">'Service does not exist!'</span><span class="p">);</span>
        <span class="p">}</span>
    
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">registry</span><span class="p">[</span><span class="nv">$id</span><span class="p">];</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">set</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="kt">object</span> <span class="nv">$object</span><span class="p">):</span> <span class="kt">void</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">registry</span><span class="p">[</span><span class="nv">$id</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$object</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="n">has</span><span class="p">(</span><span class="nv">$id</span><span class="p">):</span> <span class="kt">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">registry</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And a simple usage of this container would be like:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$container</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Container</span><span class="p">();</span>

<span class="nv">$serviceA</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceA</span><span class="p">();</span>
<span class="nv">$serviceB</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServiceB</span><span class="p">(</span><span class="nv">$serviceA</span><span class="p">);</span>

<span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'service_a'</span><span class="p">,</span> <span class="nv">$serviceA</span><span class="p">);</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="s1">'service_b'</span><span class="p">,</span> <span class="nv">$serviceB</span><span class="p">);</span>

<span class="c1">// Somewhere in the application</span>
<span class="nv">$container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="s1">'service_b'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">doSomethingUsingServiceA</span><span class="p">(</span><span class="mf">...</span><span class="p">);</span>
</code></pre></div></div>

<p>But in most cases we won’t end up using this container as it’s not memory and time efficient because we have to instantiate every service we want to be registered in the container, instead, we use an advanced container with the ability to learn how to create a service like <a href="https://symfony.com/doc/current/components/dependency_injection.html">Symfony DependencyInjection component</a>.</p>

<p>Furthermore, using service locator design pattern in most cases is considered an anti-pattern and has very concerning drawbacks that in my opinion, every developer should avoid using when dependency injection is available.</p>

<h2>What is dependency injection?</h2>
<p><img src="/assets/images/CouplingVsCohesion.svg" alt="Coupling VS Cohesion" /></p>

<p>As <a href="https://en.wikipedia.org/wiki/Dependency_injection">WikiPedia</a> describes it:</p>

<blockquote>
  <p>dependency injection is a design pattern in which an object or function receives other objects or functions that it depends on. A form of inversion of control, dependency injection aims to separate the concerns of constructing objects and using them, leading to loosely coupled programs.</p>
</blockquote>

<p>I describe it as a way for services to talk to each other without knowing each other’s implementation.</p>

<h2>What are the drawbacks?</h2>
<p>The main drawbacks of using service locator fall into two categories:</p>

<ul>
  <li>Types are not known in runtime which makes the code error-prone.</li>
  <li>Dependencies of class are hidden and to write unit tests you have to go through the code and find the dependencies.</li>
</ul>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Good</span>
<span class="kd">class</span> <span class="nc">Service</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="kt">Dummy</span> <span class="nv">$dummy</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">doSomething</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">dummy</span><span class="o">-&gt;</span><span class="nf">something</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Bad</span>
<span class="kd">class</span> <span class="nc">Service</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__constructor</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="kt">ContainerInterface</span> <span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="n">doSomething</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// We can't be sure this return dummy or any service!</span>
        <span class="nv">$dummy</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="n">container</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nc">Dummy</span><span class="o">::</span><span class="n">class</span><span class="p">);</span>

        <span class="c1">// We don't know method `something` exists in the $dummy variable!</span>
        <span class="nv">$dummy</span><span class="o">-&gt;</span><span class="nf">something</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2>What is wrong with Laravel?</h2>
<p>Laravel like many other frameworks uses dependency injection design pattern but the problem is that it promotes and uses service locator more!</p>

<h3>Helpers</h3>
<p>There are many helpers in Laravel that use service locator. For instance, take a look at how <code class="language-plaintext highlighter-rouge">config(...)</code> works:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Get / set the specified configuration value.
 *
 * If an array is passed as the key, we will assume you want to set an array of values.
 *
 * @param  array|string|null  $key
 * @param  mixed  $default
 * @return mixed|\Illuminate\Config\Repository
 */</span>
<span class="k">function</span> <span class="n">config</span><span class="p">(</span><span class="nv">$key</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">$default</span> <span class="o">=</span> <span class="kc">null</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">is_null</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">app</span><span class="p">(</span><span class="s1">'config'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">is_array</span><span class="p">(</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">app</span><span class="p">(</span><span class="s1">'config'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">set</span><span class="p">(</span><span class="nv">$key</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nf">app</span><span class="p">(</span><span class="s1">'config'</span><span class="p">)</span><span class="o">-&gt;</span><span class="nf">get</span><span class="p">(</span><span class="nv">$key</span><span class="p">,</span> <span class="nv">$default</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The ironic part of these helpers is that in most cases, you can inject the implementation directly into your class but many developers don’t know or even decide not to!</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">use</span> <span class="nc">Illuminate\Config\Repository</span><span class="p">;</span>

<span class="kd">class</span> <span class="nc">Service</span> <span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="n">__construct</span><span class="p">(</span><span class="k">private</span> <span class="k">readonly</span> <span class="kt">Repository</span> <span class="nv">$config</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3>Facades</h3>
<p>Facade is another of many idiotic ideas that was introduced in Laravel which made naive developers use it a lot and never learn that swapping the implementation of a dependency can be easily done using an interface!</p>

<blockquote>
  <p>Facades provide a “static” interface to classes that are available in the application’s service container.</p>
</blockquote>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cd">/**
 * Resolve the facade root instance from the container.
 *
 * @param  string  $name
 * @return mixed
 */</span>
<span class="k">protected</span> <span class="k">static</span> <span class="k">function</span> <span class="n">resolveFacadeInstance</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$resolvedInstance</span><span class="p">[</span><span class="nv">$name</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$resolvedInstance</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$app</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">static</span><span class="o">::</span><span class="nv">$cached</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$resolvedInstance</span><span class="p">[</span><span class="nv">$name</span><span class="p">]</span> <span class="o">=</span> <span class="k">static</span><span class="o">::</span><span class="nv">$app</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">static</span><span class="o">::</span><span class="nv">$app</span><span class="p">[</span><span class="nv">$name</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In some cases I even see some developers using facades without having any intention of swapping the underlying implementation in future.</p>

<p><a href="https://laravel.com/docs/9.x/facades#facades-vs-dependency-injection">Facade VS Dependency Injection</a></p>

<h2>Conculusion</h2>
<p>If you want to write maintainable and testable code, you should avoid using service locator and facades and helpers … . Dependencies of a class are better to be exposed and visible rather than hidden.</p>

  </div>

  

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <p>
      

&copy; Alireza Mirsepassi - Powered by <a href="https://jekyllrb.com">Jekyll</a> &amp; <a href="https://github.com/yous/whiteglass">whiteglass</a> - Subscribe via <a href="https://read.adumb.codes/feed.xml">RSS</a>

    </p>

  </div>

</footer>


  </body>

</html>
